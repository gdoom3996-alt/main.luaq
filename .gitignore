-- LocalScript (StarterGui)

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")
local UserInputService = game:GetService("UserInputService")

local LP = Players.LocalPlayer
local Camera = workspace.CurrentCamera

-------------------------------------------------
-- 설정값
-------------------------------------------------
local FOV_RADIUS = 120
local FOV_MIN = 50
local FOV_MAX = 300

local AIM_SPEED = 250
local AIMBOT = false
local WALLCHECK = true

-------------------------------------------------
-- GUI
-------------------------------------------------
local gui = Instance.new("ScreenGui", LP:WaitForChild("PlayerGui"))

-- AIMBOT 버튼
local aimbotBtn = Instance.new("TextButton", gui)
aimbotBtn.Size = UDim2.new(0,180,0,55)
aimbotBtn.Position = UDim2.new(0.05,0,0.40,0)
aimbotBtn.Text = "AIMBOT : OFF"
aimbotBtn.TextScaled = true
aimbotBtn.BackgroundColor3 = Color3.fromRGB(120,0,0)
aimbotBtn.TextColor3 = Color3.new(1,1,1)

-- WallCheck 버튼
local wallBtn = Instance.new("TextButton", gui)
wallBtn.Size = UDim2.new(0,180,0,45)
wallBtn.Position = UDim2.new(0.05,0,0.40,60)
wallBtn.Text = "WALLCHECK : ON"
wallBtn.TextScaled = true
wallBtn.BackgroundColor3 = Color3.fromRGB(0,120,0)
wallBtn.TextColor3 = Color3.new(1,1,1)

-------------------------------------------------
-- FOV 원
-------------------------------------------------
local FOV = Drawing.new("Circle")
FOV.Radius = FOV_RADIUS
FOV.Thickness = 2
FOV.NumSides = 64
FOV.Filled = false
FOV.Color = Color3.fromRGB(255,0,0)
FOV.Visible = true

-------------------------------------------------
-- 유틸
-------------------------------------------------
local function wallCheck(head, char)
	if not WALLCHECK then return true end

	local origin = Camera.CFrame.Position
	local dir = head.Position - origin

	local params = RaycastParams.new()
	params.FilterType = Enum.RaycastFilterType.Blacklist
	params.FilterDescendantsInstances = {LP.Character, char}
	params.IgnoreWater = true

	return Workspace:Raycast(origin, dir, params) == nil
end

local function inFOV(pos)
	local screen, onScreen = Camera:WorldToViewportPoint(pos)
	if not onScreen then return false end

	local center = Vector2.new(Camera.ViewportSize.X/2, Camera.ViewportSize.Y/2)
	local dist = (Vector2.new(screen.X, screen.Y) - center).Magnitude
	return dist <= FOV_RADIUS, dist
end

-------------------------------------------------
-- 타겟
-------------------------------------------------
local function getTarget()
	local best, bestDist = nil, math.huge

	for _,p in pairs(Players:GetPlayers()) do
		if p ~= LP and p.Character then
			local char = p.Character
			local head = char:FindFirstChild("Head")
			local hum = char:FindFirstChild("Humanoid")

			if head and hum and hum.Health > 0 then
				local ok, dist = inFOV(head.Position)
				if ok and wallCheck(head, char) and dist < bestDist then
					bestDist = dist
					best = head
				end
			end
		end
	end

	return best
end

-------------------------------------------------
-- 메인 루프
-------------------------------------------------
RunService.RenderStepped:Connect(function(dt)
	FOV.Position = Vector2.new(
		Camera.ViewportSize.X/2,
		Camera.ViewportSize.Y/2
	)
	FOV.Radius = FOV_RADIUS

	if not AIMBOT then
		FOV.Color = Color3.fromRGB(255,0,0)
		return
	end

	local target = getTarget()
	if target then
		FOV.Color = Color3.fromRGB(0,255,0)
		local targetCF = CFrame.new(Camera.CFrame.Position, target.Position)
		local alpha = math.clamp(AIM_SPEED * dt, 0, 1)
		Camera.CFrame = Camera.CFrame:Lerp(targetCF, alpha)
	else
		FOV.Color = Color3.fromRGB(255,0,0)
	end
end)

-------------------------------------------------
-- 버튼
-------------------------------------------------
aimbotBtn.MouseButton1Click:Connect(function()
	AIMBOT = not AIMBOT
	aimbotBtn.Text = AIMBOT and "AIMBOT : ON" or "AIMBOT : OFF"
end)

wallBtn.MouseButton1Click:Connect(function()
	WALLCHECK = not WALLCHECK
	wallBtn.Text = WALLCHECK and "WALLCHECK : ON" or "WALLCHECK : OFF"
end)

-------------------------------------------------
-- 슬라이더 드래그
-------------------------------------------------
local dragging = false

sliderKnob.InputBegan:Connect(function(input)
	if input.UserInputType == Enum.UserInputType.MouseButton1 then
		dragging = true
	end
end)

UserInputService.InputEnded:Connect(function(input)
	if input.UserInputType == Enum.UserInputType.MouseButton1 then
		dragging = false
	end
end)

UserInputService.InputChanged:Connect(function(input)
	if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
		local x = math.clamp(
			(input.Position.X - sliderBar.AbsolutePosition.X) / sliderBar.AbsoluteSize.X,
			0, 1
		)

		sliderKnob.Position = UDim2.new(x,0,0.5,0)
		FOV_RADIUS = math.floor(FOV_MIN + (FOV_MAX - FOV_MIN) * x)
		sliderText.Text = "FOV : "..FOV_RADIUS
	end
end)
